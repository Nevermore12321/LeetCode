[toc]

# 对pod进行资源分配和资源限制

有两种方式可以限制资源：
1. 在pod的属性中配置
    - resource 字段
2. 通过 limitRange 限制


注意：
- 在kubernetes系统上，1个单位的cpu相当于虚拟机上的一颗虚拟cpu（vcpu），或者相当于物理机上的一个超线程（HyperThread，也就是一个逻辑CPU）
- 支持分数计量方式
    - 一个核心（1 core）相当于1000个微核心（millicores）
    - 因此，500m 相当于0.5个核心，即二分之一个核心。

## 1. resource 限制

resource 下有两个字段：
1. requests : 表示容器所在节点资源的最小值
2. limits : 表示消耗资源的最大值

其中：requests 和 limits 下都有两个字段以供限制：
1. memory : 内存
2. cpu : cpu

**yaml 文件的模板为：**
```
apiVersion: v1
kind: Pod
metadata:
  name: memory-demo
  namespace: mem-example
spec:
  containers:
  - name: memory-demo-ctr
    image: polinux/stress
    resources:
      limits:
        memory: "200Mi"
        cpu: "512Mi"
      requests:
        memory: "100Mi"
        cpu: "256Mi"
    command: ["stress"]
```



## 2. limitRange 限制

一个 LimitRange（限制范围） 对象提供的限制能够做到：
- 在一个命名空间中实施对每个 Pod 或 Container 最小和最大的资源使用量的限制。
- 在一个命名空间中实施对每个 PersistentVolumeClaim 能申请的最小和最大的存储空间大小的限制。
- 在一个命名空间中实施对一种资源的申请值和限制值的比值的控制。
设置一个命名空间中对计算资源的默认申请/限制值，并且自动的在运行时注入到多个 Container 中


注意：如果pod中设置了resources来限制，又有limitrange限制，那么：
- 如果容器里声明了请求和限制大于或者小于 limitrange里的max或者min，都会导致pod创建不成功。
- 也就是说pod中resources的范围，必须小于 limitrange 的范围，是其的一个子集。



**limitRange的yaml文件**
```
apiVersion: v1
kind: LimitRange
metadata:
  name: cpu-min-max-demo-lr
spec:
  limits:
  - max:
      cpu: "800m"
    min:
      cpu: "200m"
    type: Container
```
**limitRange 设置default默认值**
```

apiVersion: v1
kind: LimitRange
metadata:
  name: mem-limit-range
spec:
  limits:
  - default:
      memory: 512Mi
    defaultRequest:
      memory: 256Mi
    type: Container
```
注意：如果容器里没有声明请求和限制则
使用默认的请求和限制






# 对命名空间进行资源配额

例如： 某个命名空间中最多能创建多少个pod

注意：
- limitrange 用来限制每个pod的资源
- resourcequota 用来限制项目里可以使用多少资源


**创建 resourcequota 的模板文件为：**
```
apiVersion: v1
kind: ResourceQuota
metadata:
  name: compute-resources
spec:
  hard:
    pods: "4"
    requests.cpu: "1"
    requests.memory: 1Gi
    limits.cpu: "2"
    limits.memory: 2Gi
    requests.nvidia.com/gpu: 4
    configmaps: "10"
    persistentvolumeclaims: "4"
    replicationcontrollers: "20"
    secrets: "10"
    services: "10"
    services.loadbalancers: "2"
```